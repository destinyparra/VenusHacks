<!DOCTYPE html>
<html>

<head>
    <title>Map View</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="static/styles.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Map View</h1>
        <a href="{{ url_for('home') }}"
            style="display:inline-block;padding:10px 20px;background:#2c3e50;color:#fff;text-decoration:none;border-radius:5px;margin-bottom:20px;">Back
            to Home</a>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([33.645968217866574, -117.84270903384764], 16);

        var myIcon = L.icon({
            iconUrl: 'static/images/tampon_icon.png',
            iconSize: [40, 70],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76]
        });

        var userIcon = L.icon({
            iconUrl: 'static/images/Woman_icon.png',
            iconSize: [30, 50],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76]
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        //get from database (no more json)
        fetch('/locations')
            .then(response => response.json())
            .then(data => {
                data.forEach(location => {
                    const popupContent = (loc) => `
                    <div id="view-${loc.id}">
                        <strong>${loc.name}</strong><br>
                        Pads Availability: ${loc.pads_availability}<br>
                        Tampons Availability: ${loc.tampons_availability}<br>
                        Free: ${loc.free}<br>
                        Accessible: ${loc.accessibility ? "Yes" : "No"}<br>
                        Last Updated: ${loc.last_updated}<br>
                        <button onclick="showEditForm(${loc.id})">Update Stock</button>
                    </div>
                    <div id="edit-${loc.id}" style="display:none;">
                        <label for="pads-${loc.id}">Pads:</label>
                        <select id="pads-${loc.id}">
                            <option value="Low" ${loc.pads_availability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${loc.pads_availability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Stocked" ${loc.pads_availability === 'Stocked' ? 'selected' : ''}>Stocked</option>
                        </select><br>
                        <label for="tampons-${loc.id}">Tampons:</label>
                        <select id="tampons-${loc.id}">
                            <option value="Low" ${loc.tampons_availability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${loc.tampons_availability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Stocked" ${loc.tampons_availability === 'Stocked' ? 'selected' : ''}>Stocked</option>
                        </select><br>
                        <button onclick="submitUpdate(${loc.id})">Submit</button>
                        <button onclick="cancelEdit(${loc.id})">Back</button>
                    </div>
                `;

                const marker = L.marker([location.latitude, location.longitude], { icon: myIcon })
                    .addTo(map)
                    .bindPopup(popupContent(location));
                            });
        });

        //show user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLat = position.coords.latitude;
                var userLng = position.coords.longitude;
                L.marker([userLat, userLng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('You are here')
                    .openPopup();
                map.setView([userLat, userLng], 16);
            }, function () {
                alert('Geolocation failed. Please allow location access.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }

    function showEditForm(id) {
        document.getElementById(`view-${id}`).style.display = 'none';
        document.getElementById(`edit-${id}`).style.display = 'block';
    }

    function cancelEdit(id) {
        document.getElementById(`edit-${id}`).style.display = 'none';
        document.getElementById(`view-${id}`).style.display = 'block';
    }

    function submitUpdate(id) {
        const pads = document.getElementById(`pads-${id}`).value;
        const tampons = document.getElementById(`tampons-${id}`).value;

        fetch(`/update_stock/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pads_availability: pads,
                tampons_availability: tampons
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload(); 
            } else {
                alert('Update failed.');
            }
        });
    }

    </script>
</body>

</html>