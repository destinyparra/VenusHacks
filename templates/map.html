<!DOCTYPE html>
<html>

<head>
    <title>Map View</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- <link rel="stylesheet" href="static/styles.css" /> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

</head>

<body class="map-page">
    <div class="floating-hearts" id="hearts"></div>
    <nav class="navbar">
        <div class="nav-logo">ðŸ’– Zot Spot</div>
        <div class="nav-links">
            <a href="{{ url_for('home') }}" class="back-btn">Home</a>
            <a href="{{ url_for('map_view') }}">Map</a>
            <a href="{{ url_for('map_view') }}#report">Report</a>
            <a href="#contact">Contact</a>
        </div>
    </nav>
    <!-- <div class="container"> -->
    <div class="header">
        <h1>
            <span class="emoji">ðŸ’–</span> Zot Spot <span class="emoji">ðŸ’–</span>
        </h1>
    </div>

    <a href="{{ url_for('home') }}" class="back-btn">
        Back to Home
    </a>

    <div class="map-container">
        <div class="controls">

        </div>
        <div id="map"></div>
    </div>

    <!-- <div id="locations-container"></div> -->

    <div class="design-card">
        <h2 class="design-title">Bathrooms Near Me</h2>
        <div class="list-layout" id="building-list">
            <!-- List items will be injected here by JS -->
        </div>
    </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([33.645968217866574, -117.84270903384764], 16);
        var myIcon = L.icon({
            iconUrl: 'static/images/tampon_icon.png',
            iconSize: [40, 70],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76]
        });
        var userIcon = L.icon({
            iconUrl: 'static/images/Woman_icon.png',
            iconSize: [30, 50],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76]
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        //display locations (by floor) and update-form for each location
        fetch('/locations')
            .then(response => response.json())
            .then(data => {
                const groups = {};

                data.forEach(location => {
                    if (!groups[location.location_group]) {
                        groups[location.location_group] = [];
                    }
                    groups[location.location_group].push(location);
                });

                for (const groupName in groups) {
                    const locations = groups[groupName];
                    const { latitude, longitude } = locations[0];
                    const groupMarker = L.marker([latitude, longitude], { icon: myIcon }).addTo(map);

                    let floorOptions = `<option value="">Select Floor</option>`;
                    locations.forEach(loc => {
                        floorOptions += `<option value="${loc.id}">${loc.floor || loc.name}</option>`;
                    });


                    groupMarker.bindPopup(`
                            <div>
                            <strong>Group: ${groupName}</strong><br>
                            <label for="floor-select-${groupName}">Choose Floor:</label><br>
                            <select id="floor-select-${groupName}">
                                ${floorOptions}
                            </select>
                            <div id="floor-details-${groupName}" style="margin-top: 10px;"></div>
                            </div>
                        `);

                    groupMarker.on('popupopen', () => {
                        const selectEl = document.getElementById(`floor-select-${groupName}`);
                        const detailsDiv = document.getElementById(`floor-details-${groupName}`);

                        selectEl.onchange = () => {
                            const selectedID = selectEl.value;
                            if (!selectedID) {
                                detailsDiv.innerHTML = '';
                                return;
                            }
                            const location = locations.find(l => l.id == selectedID);
                            detailsDiv.innerHTML = renderView(location);
                        };
                    });
                }
                renderGroups(groups);
            });

        function renderGroups(groups) {
            const container = document.getElementById('building-list');
            container.innerHTML = '';

            for (const groupName in groups) {
                const groupLocations = groups[groupName];

                const card = document.createElement('div');
                card.className = 'bathroom-card';

                const header = document.createElement('div');
                header.className = 'bathroom-header';

                const title = document.createElement('h3');
                title.innerHTML = `${groupName}`;
                header.appendChild(title);

                const select = document.createElement('select');
                select.innerHTML = '<option value="">Select Floor</option>';
                groupLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.floor || loc.name;
                    select.appendChild(option);
                });
                header.appendChild(select);
                card.appendChild(header);

                const details = document.createElement('div');
                details.className = 'bathroom-details';
                card.appendChild(details);

                select.addEventListener('change', () => {
                    const selectedID = select.value;
                    const location = groupLocations.find(l => l.id == selectedID);
                    details.innerHTML = location ? renderView(location) : '';
                });

                container.appendChild(card);
            }
        }

        function renderView(location) {
            return `
                <div id="view-${location.id}">
                    <strong>${location.name}</strong><br>
                    Pads: ${location.pads_availability}<br>
                    Tampons: ${location.tampons_availability}<br>
                    Free: ${location.free ? 'Yes' : 'No'}<br>
                    Accessible: ${location.accessibility ? 'Yes' : 'No'}<br>
                    Last Updated: ${location.last_updated}<br>
                    <button onclick="showEditForm(${location.id},'${location.pads_availability}', '${location.tampons_availability}')">Update Stock</button>
                </div>
                <div id="edit-${location.id}" style="display:none;"></div>`;
        }

        function showEditForm(id, padsAvailability, tamponsAvailability) {
            const viewDiv = document.getElementById(`view-${id}`);
            const editDiv = document.getElementById(`edit-${id}`);
            viewDiv.style.display = 'none';
            //editDiv.style.display = 'block';

            editDiv.innerHTML = `
                    <form onsubmit="submitUpdate(event, ${id})">
                        <label for="pads-${id}">Pads:</label>
                        <select id="pads-${id}">
                            <option value="Low" ${padsAvailability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${padsAvailability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Stocked" ${padsAvailability === 'Stocked' ? 'selected' : ''}>Stocked</option>
                        </select><br>

                        <label for="pads-${id}">Tampons:</label>
                        <select id="tampons-${id}">
                            <option value="Low" ${tamponsAvailability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${tamponsAvailability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Stocked" ${tamponsAvailability === 'Stocked' ? 'selected' : ''}>Stocked</option>
                        </select><br>

                        <button onclick="submitUpdate(${id})">Save</button>
                        <button onclick="cancelEdit(${id})">Cancel</button>
                    </form>
                `;
            editDiv.style.display = 'block';
        }

        function cancelEdit(id) {
            document.getElementById(`edit-${id}`).style.display = 'none';
            document.getElementById(`view-${id}`).style.display = 'block';
        }

        function submitUpdate(event, id) {
            event.preventDefault();
            const pads = document.getElementById(`pads-${id}`).value;
            const tampons = document.getElementById(`tampons-${id}`).value;

            fetch(`/update_stock/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pads_availability: pads,
                    tampons_availability: tampons
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        location.reload();
                    }
                    else {
                        alert('Update failed.');
                    }
                });
        }

        //show user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLat = position.coords.latitude;
                var userLng = position.coords.longitude;
                L.marker([userLat, userLng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('You are here')
                    .openPopup();
                map.setView([userLat, userLng], 16);
            }, function () {
                alert('Geolocation failed. Please allow location access.');
            });
        }
        else {
            alert('Geolocation is not supported by this browser.');
        }


    </script>

</body>

</html>