<!DOCTYPE html>
<html>

<head>
    <title>Map View</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" /> -->
    <link rel="stylesheet" href="static/styles.css" />


    <style>
        #map {
            height: 500px;
            width: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- <div class="container">
        <h1>Map View</h1>
        <div id="map"></div>
    </div> -->

    <div class="container">
        <h1>Map View</h1>
        <a href="{{ url_for('home') }}"
            style="display:inline-block;padding:10px 20px;background:#2c3e50;color:#fff;text-decoration:none;border-radius:5px;margin-bottom:20px;">Back
            to Home</a>
        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([33.645968217866574, -117.84270903384764], 16); // UCI campus
        var myIcon = L.icon({
            iconUrl: 'static/images/tampon_icon.png',
            iconSize: [40, 70],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76],
            // shadowUrl: 'my-icon-shadow.png',
            // shadowSize: [68, 95],
            // shadowAnchor: [22, 94]
        });
        var userIcon = L.icon({
            iconUrl: 'static/images/Woman_icon.png',
            iconSize: [30, 50],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76],
            // shadowUrl: 'my-icon-shadow.png',
            // shadowSize: [68, 95],
            // shadowAnchor: [22, 94]
        });

        // L.marker([50.505, 30.57], { icon: myIcon }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        // L.marker([33.64252877591157, -117.84161569140684])
        //     .addTo(map)
        //     .bindPopup('UCI Campus')
        //     .openPopup();
        let userLat = null;
        let userLng = null;

        // Get user's current location first
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;
                L.marker([userLat, userLng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('You are here')
                    .openPopup();
                map.setView([userLat, userLng], 16);
            }, function () {
                alert('Geolocation failed. Please allow location access.');
            });
        } else {
            alert('Geolocation is not supported by this browser.');
        }

        fetch('/static/bathrooms.json')
            .then(response => response.json())
            .then(data => {
                data.forEach(bathroom => {
                    const marker = L.marker([bathroom.latitude, bathroom.longitude], { icon: myIcon })
                        .addTo(map);

                    // set inital popup content
                    let popupContent = `<strong>${bathroom.name}</strong>`;
                    marker.bindPopup(popupContent);

                    // Add click event to update popup content with distance
                    marker.on('click', function () {
                        let popupContent = `<strong>${bathroom.name}</strong>`;
                        if (userLat !== null && userLng !== null) {
                            const distKm = getDistanceFromLatLonInKm(userLat, userLng, bathroom.latitude, bathroom.longitude);
                            const distMiles = (distKm * 0.621371);
                            const walkTimeMin = Math.round((distMiles / 3.1) * 60); // 5 km/h walking speed
                            popupContent += `<br><span>Estimated walk: ${walkTimeMin} min (${distKm.toFixed(2)} mi)</span>`;
                        } else {
                            popupContent += `<br><span>Enable location to see walking time.</span>`;
                        }
                        marker.bindPopup(popupContent).openPopup();
                    });
                });
            });
        // // get users current location
        // if (navigator.geolocation) {
        //     navigator.geolocation.getCurrentPosition(function (position) {
        //         var userLat = position.coords.latitude;
        //         var userLng = position.coords.longitude;
        //         L.marker([userLat, userLng], { icon: userIcon })
        //             .addTo(map)
        //             .bindPopup('You are here')
        //             .openPopup();
        //         map.setView([userLat, userLng], 16);
        //     }, function () {
        //         alert('Geolocation failed. Please allow location access.');
        //     });
        // } else {
        //     alert('Geolocation is not supported by this browser.');
        // }

        // Calculate distance in kilometers between two lat/lng points
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius of the earth in km
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distance in km
            return d;
        }
    </script>
</body>

</html>