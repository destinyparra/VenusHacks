<!DOCTYPE html>
<html>

<head>
    <title>Map View</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="static/styles.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

</head>

<body>

    <div class="floating-hearts" id="hearts"></div>

    <div class="container">
        <div class="header">
            <h1>ðŸ’– Zot Spot ðŸ’–</h1>
        </div>

        <a href="{{ url_for('home') }}" class="back-btn">
            Back to Home
        </a>

        <div class="map-container">
            <div class="controls">

            </div>
            <div id="map"></div>
        </div>

        <div class="design-card">
            <h2 class="design-title">Bathrooms Near Me</h2>
            <div class="list-layout" id="building-list">
                <div class="building-item">
                    <div class="building-header">
                        <span class="building-name">Student Center</span>
                        <span class="distance">0.2 mi</span>
                    </div>
                    <div class="bathroom-list">
                        <div class="bathroom-item">
                            <span>1st Floor - Women's</span>
                            <span class="status-badge badge-available">Stocked</span>
                        </div>
                        <div class="bathroom-item">
                            <span>2nd Floor - Women's</span>
                            <span class="status-badge badge-low">Low</span>
                        </div>
                    </div>
                </div>
                <div class="building-item">
                    <div class="building-header">
                        <span class="building-name">Langson Library</span>
                        <span class="distance">0.4 mi</span>
                    </div>
                    <div class="bathroom-list">
                        <div class="bathroom-item">
                            <span>Ground Floor - All Gender</span>
                            <span class="status-badge badge-available">Stocked</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            var map = L.map('map').setView([33.645968217866574, -117.84270903384764], 16);

            var myIcon = L.icon({
                iconUrl: 'static/images/tampon_icon.png',
                iconSize: [40, 70],
                iconAnchor: [22, 94],
                popupAnchor: [-3, -76]
            });

            var userIcon = L.icon({
                iconUrl: 'static/images/Woman_icon.png',
                iconSize: [30, 50],
                iconAnchor: [22, 94],
                popupAnchor: [-3, -76]
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            //get from database (no more json)
            fetch('/locations')
                .then(response => response.json())
                .then(data => {
                    data.forEach(location => {
                        const popupContent = (loc) => `
                    <div id="view-${loc.id}">
                        <strong>${loc.name}</strong><br>
                        Pads Availability: ${loc.pads_availability}<br>
                        Tampons Availability: ${loc.tampons_availability}<br>
                        Free: ${loc.free}<br>
                        Accessible: ${loc.accessibility ? "Yes" : "No"}<br>
                        Last Updated: ${loc.last_updated}<br>
                        <button onclick="showEditForm(${loc.id})">Update Stock</button>
                    </div>
                    <div id="edit-${loc.id}" style="display:none;">
                        <label for="pads-${loc.id}">Pads:</label>
                        <select id="pads-${loc.id}">
                            <option value="Low" ${loc.pads_availability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${loc.pads_availability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Stocked" ${loc.pads_availability === 'Stocked' ? 'selected' : ''}>Stocked</option>
                        </select><br>
                        <label for="tampons-${loc.id}">Tampons:</label>
                        <select id="tampons-${loc.id}">
                            <option value="Low" ${loc.tampons_availability === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${loc.tampons_availability === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="Stocked" ${loc.tampons_availability === 'Stocked' ? 'selected' : ''}>Stocked</option>
                        </select><br>
                        <button onclick="submitUpdate(${loc.id})">Submit</button>
                        <button onclick="cancelEdit(${loc.id})">Back</button>
                    </div>
                `;

                        const marker = L.marker([location.latitude, location.longitude], { icon: myIcon })
                            .addTo(map)
                            .bindPopup(popupContent(location));
                    });
                });

            // vars for users location (used to calculate distance)
            var userLat = null;
            var userLng = null;

            //show user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    L.marker([userLat, userLng], { icon: userIcon })
                        .addTo(map)
                        .bindPopup('You are here')
                        .openPopup();
                    map.setView([userLat, userLng], 16);
                }, function () {
                    alert('Geolocation failed. Please allow location access.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }

            // Make updates to the stock

            function showEditForm(id) {
                document.getElementById(`view-${id}`).style.display = 'none';
                document.getElementById(`edit-${id}`).style.display = 'block';
            }

            function cancelEdit(id) {
                document.getElementById(`edit-${id}`).style.display = 'none';
                document.getElementById(`view-${id}`).style.display = 'block';
            }

            function submitUpdate(id) {
                const pads = document.getElementById(`pads-${id}`).value;
                const tampons = document.getElementById(`tampons-${id}`).value;

                fetch(`/update_stock/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pads_availability: pads,
                        tampons_availability: tampons
                    })
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            location.reload();
                        } else {
                            alert('Update failed.');
                        }
                    });
            }

            // Calculate distance in kilometers between two lat/lng points
            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                var R = 6371; // Radius of the earth in km
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLon = (lon2 - lon1) * Math.PI / 180;
                var a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                var d = R * c; // Distance in km
                return d;
            }

        </script>
</body>

</html>